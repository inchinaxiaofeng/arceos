PLATFORM=riscv64-linux-musl
CC=$(PLATFORM)-gcc
AS=$(PLATFORM)-as
LD=$(PLATFORM)-ld
AR=$(PLATFORM)-ar
STRIP=$(PLATFORM)-strip
OBJCOPY=$(PLATFORM)-objcopy

INTERNAL_INCLUDE = -I./c/math/ -I./c/include/ -I./include -I./c/internal/ -I./c/time/ -I./arch/riscv64/ -I./c/__hidden/
CFLAGS = -nostartfiles -ffreestanding -nostdlib -O0 -mcmodel=medany $(INTERNAL_INCLUDE) -fPIC 
# CFLAGS += -fvisibility=hidden # 尝试修正compile-rt被-nolib屏蔽的问题，也就是__getf2符号没有的问题。
ASFLAGS = 
LDFLAGS := #"$($(CC) -print-libgcc-file-name)"# -T link.ld
LINK_FLAGS += /home/marinatoo/App/riscv64-linux-musl-cross/bin/../lib/gcc/riscv64-linux-musl/11.2.1/libgcc.a # 尝试修正compile-rt被-nolib屏蔽的问题，也就是__getf2符号没有的问题。
LIB_DIRS = lib
OBJ_DIRS = obj

LIB = $(LIB_DIRS)/libmock.a
SHARED_LIB = $(LIB_DIRS)/libmock.so
LIBSRC = $(wildcard c/stdio/*.c) \
				 $(wildcard c/ctype/*.c) \
				 $(wildcard c/stdlib/*.c) \
				 $(wildcard c/time/*.c) \
				 $(wildcard c/string/*.c) \
				 $(wildcard c/fenv/*.c) \
				 $(wildcard c/thread/*.c) \
				 $(wildcard c/unistd/*.c) \
				 $(wildcard c/__hidden/*.c) \
				 $(wildcard c/__file/*.c) \
				 $(wildcard c/math/*.c) \
				 $(wildcard c/complex/*.c) \
				 $(wildcard c/errno/*.c) \
#				 $(wildcard c/network/*.c) \

LIBO = $(patsubst %.c, %.o, $(LIBSRC))
LIBOBJS = $(patsubst c/%, $(OBJ_DIRS)/%, $(LIBO))
CRTOBJS = $(OBJ_DIRS)/crt1.o

all: clean $(LIB) $(SHARED_LIB) $(CRTOBJS) $(LIBOBJS)

static: $(LIB) $(CRTOBJS) $(LIBOBJS)

dynamic: $(SHARED_LIB) $(CRTOBJS) $(LIBOBJS)

$(OBJ_DIRS):
	mkdir -p $@

$(LIB_DIRS):
	mkdir -p $@

$(LIBOBJS): | $(dir $(LIBOBJS))
$(CRTOBJS): | $(dir $(CRTOBJS))

$(CRTOBJS): c/crt1.c include/crt_arch.h
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJ_DIRS)/%.o: c/%.c
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJ_DIRS)/%.o: c/%.s
	$(AS) $(ASFLAGS) -o $@ $<

$(LIB): $(LIBOBJS) $(CRTOBJS)
	$(AR) rcs $@ $(LIBOBJS)

$(SHARED_LIB): $(LIBOBJS) $(CRTOBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) -shared -fPIC -o $@ $^

clean:
	@rm $(SHARED_LIB) -rf
	@rm $(CRTOBJS) -rf
	@rm $(LIBOBJS) -rf
	@rm $(LIB_DIRS)/* -rf

.PHONYD: all clean static dynamic
